# ğŸš€ Automatischer Release-Workflow fÃ¼r TI99_Char_Tools
# Dieser Workflow wird bei jedem Push zum Haupt-Branch ausgelÃ¶st
# Er baut das Projekt im Release-Modus, liest die Version aus der EXE-Datei
# und verÃ¶ffentlicht ein GitHub Release mit passendem Tag â€“ vÃ¶llig automatisch

name: Auto Release â€“ TI99_Char_Tools

on:
  push:
    branches:
      - master  # â¬…ï¸ Nur auslÃ¶sen, wenn auf den main-Branch gepusht wird

# ğŸŒ Globale Variablen (Umgebungsvariablen), die wir im gesamten Workflow nutzen kÃ¶nnen
env:
  PROJECT_NAME: TI99_Char_Tools         # Name des Projektordners UND des .csproj-Files
  EXE_NAME: TI99_Char_Tools.exe         # Name der erzeugten EXE-Datei
  TAG_PREFIX: char                      # Tag-PrÃ¤fix, z.â€¯B. "disk-v1.2.3456.7890"

jobs:
  release:
    name: Build & Release TI99_Char_Tools
    runs-on: windows-latest             # Wir verwenden einen Windows-Runner, damit MSBuild lÃ¤uft

    steps:
    # ğŸ“¦ 1. Repository auschecken
    - name: Checkout code
      uses: actions/checkout@v3

    # ğŸ”§ 2. MSBuild konfigurieren (damit wir Projekte kompilieren kÃ¶nnen)
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    # ğŸ“¥ 3. NuGet-AbhÃ¤ngigkeiten herunterladen
    - name: Restore NuGet packages
      run: nuget restore TI99_Tools.sln

    # ğŸ› ï¸ 4. Das Projekt im Release-Modus kompilieren
    - name: Build ${{ env.PROJECT_NAME }}
      run: msbuild ${{ env.PROJECT_NAME }}/${{ env.PROJECT_NAME }}.csproj /p:Configuration=Release

    # ğŸ” 5. Versionsnummer aus der kompilierten EXE extrahieren
    - name: Get version from .exe
      id: get_version
      shell: pwsh
      run: |
        $exePath = "${{ env.PROJECT_NAME }}\bin\Release\${{ env.EXE_NAME }}"
        $version = (Get-Item $exePath).VersionInfo.ProductVersion
        Write-Output "Detected version: $version"
        echo "::set-output name=version::$version"

    # ğŸ§¾ 6. Release erstellen, falls noch nicht vorhanden
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: ${{ env.PROJECT_NAME }} ${{ steps.get_version.outputs.version }}      # z.â€¯B. â€TI99_Char_Tools 1.0.9572.42715â€œ
        tag_name: ${{ env.TAG_PREFIX }}-v${{ steps.get_version.outputs.version }}   # z.â€¯B. â€char-v1.0.9572.42715â€œ
        files: ${{ env.PROJECT_NAME }}/bin/Release/${{ env.EXE_NAME }}              # Die EXE, die hochgeladen wird
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # â¬…ï¸ Zugriffstoken fÃ¼r die API
